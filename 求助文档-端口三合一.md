# 📋 求助文档 - 端口三合一整合

## 🔍 当前状态
- **项目**: Linux容器管理系统 (linuxdo-bash)
- **架构**: 前端React + 后端Node.js + WebSSH服务 + Grafana监控
- **部署环境**: GitHub Codespaces
- **问题**: 当前系统使用4个独立端口，需要整合为单一入口以简化隧道转发配置

## 📊 当前端口状态

### 网络监听状态
```bash
# netstat -tlnp | grep -E "(3001|3002|5173|8080)"
tcp        0      0 0.0.0.0:3002            0.0.0.0:*               LISTEN      4742/node           
tcp6       0      0 :::8080                 :::*                    LISTEN      4890/node           
```

### 服务连接测试
```bash
curl http://localhost:3001/api/health  # 连接失败
curl http://localhost:3002/            # 返回"Cannot GET /"
curl http://localhost:5173/            # 连接失败  
curl http://localhost:8080/            # 返回HTML页面
```

### 运行中的Node.js进程
```bash
# ps aux | grep node
4742/node    # webssh-server.js (端口3002)
4890/node    # grafana-server.js (端口8080)
```

## 📁 项目文件结构
```
/workspaces/linuxdo-bash/
├── frontend/
│   ├── vite.config.js              # Vite开发服务器配置
│   ├── src/App.jsx                 # 包含getBackendUrl函数
│   └── src/components/Terminal.jsx # 包含getWebSSHUrl函数
├── backend/
│   ├── server.js                   # 主API服务器(3001) - 未运行
│   ├── webssh-server.js           # WebSSH服务器(3002) - 运行中
│   └── grafana-server.js          # Grafana服务器(8080) - 运行中
├── nginx/nginx.conf                # Nginx反向代理配置
├── docker-compose.yml              # Docker编排配置
├── Dockerfile                      # 容器构建配置
└── start-all.sh                   # 服务启动脚本
```

## 🔧 现有配置文件内容

### Vite配置 (frontend/vite.config.js)
```javascript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:3001',
        changeOrigin: true
      },
      '/socket.io': {
        target: 'http://localhost:3001',
        changeOrigin: true,
        ws: true
      }
    }
  },
  build: {
    outDir: 'dist',
    assetsDir: 'assets'
  }
})
```

### 主后端服务器配置 (backend/server.js)
```javascript
// 端口配置
const PORT = process.env.PORT || 3001;
server.listen(PORT, () => {
  console.log(`Linux Analytics服务器运行在端口 ${PORT}`);
});

// Socket.IO CORS配置
const io = socketIo(server, {
  cors: {
    origin: process.env.NODE_ENV === 'production' ? true : [
      "http://localhost:5173",
      "http://localhost:5174",
      "http://localhost:5175", 
      "http://localhost:5176",
      "http://localhost:3000",
      "http://localhost:3001",
      "http://127.0.0.1:3001",
      "http://127.0.0.1:5173",
      "http://127.0.0.1:5176",
      /^https:\/\/.*\.app\.github\.dev$/
    ],
    methods: ["GET", "POST"],
    credentials: true
  }
});

// Express CORS配置
app.use(cors({
  origin: process.env.NODE_ENV === 'production' ? true : [
    "http://localhost:5173",
    "http://localhost:5174",
    "http://localhost:5175",
    "http://localhost:5176", 
    "http://localhost:3000",
    "http://localhost:3001",
    "http://127.0.0.1:3001",
    "http://127.0.0.1:5173",
    "http://127.0.0.1:5176",
    /^https:\/\/.*\.app\.github\.dev$/
  ],
  credentials: true
}));
```

### WebSSH服务器配置 (backend/webssh-server.js)
```javascript
// 端口配置
const PORT = 3002;
server.listen(PORT, '0.0.0.0', () => {
  console.log(`WebSSH server listening on 0.0.0.0:${PORT}`);
});

// CORS配置
const io = socketIo(server, {
  cors: {
    origin: "*",
    methods: ["GET", "POST"]
  }
});

// 连接到主API服务器
const mainServerSocket = ioClient('http://localhost:3001');
```

### Grafana服务器配置 (backend/grafana-server.js)
```javascript
// 端口配置
const PORT = process.env.GRAFANA_PORT || 8080;
app.listen(PORT, () => {
  console.log(`🔧 Grafana Analytics服务器运行在端口 ${PORT}`);
  console.log(`📊 访问地址: http://localhost:${PORT}`);
});
```

### 前端URL构建逻辑 (frontend/src/App.jsx)
```javascript
// 后端URL构建
const getBackendUrl = () => {
  if (window.location.hostname.includes('github.dev')) {
    // GitHub Codespaces环境
    return window.location.origin.replace('-5173', '-3001');
  }

  // 自动检测当前环境
  const protocol = window.location.protocol;
  const hostname = window.location.hostname;
  const currentPort = window.location.port;

  // 如果当前访问的是3001端口（生产环境），直接使用当前地址
  if (currentPort === '3001') {
    return `${protocol}//${hostname}:3001`;
  }

  // 如果是开发环境（5173端口）或其他端口，连接到3001
  return `${protocol}//${hostname}:3001`;
};

const backendUrl = getBackendUrl();
const newSocket = io(backendUrl, {
  autoConnect: false,
  timeout: 20000,
  reconnection: true,
  reconnectionDelay: 1000,
  reconnectionAttempts: 5,
  maxReconnectionAttempts: 5,
  forceNew: true
});
```

### 前端WebSSH URL构建逻辑 (frontend/src/components/Terminal.jsx)
```javascript
// WebSSH URL构建
const getWebSSHUrl = () => {
  if (window.location.hostname.includes('github.dev')) {
    // GitHub Codespaces环境 - 支持多个端口
    let origin = window.location.origin;
    // 替换任何前端端口为3002
    origin = origin.replace(/-517[3-9]/, '-3002');
    return origin;
  }

  // 自动检测当前环境
  const protocol = window.location.protocol;
  const hostname = window.location.hostname;

  // 使用当前主机的3002端口
  return `${protocol}//${hostname}:3002`;
};

// iframe src设置
src={`${getWebSSHUrl()}/ssh?username=${username}`}
```

### Nginx配置 (nginx/nginx.conf)
```nginx
# 上游服务器
upstream linux_backend {
    server linux-webssh-app:3001;
}

upstream linux_webssh {
    server linux-webssh-app:3002;
}

# API代理
location /api/ {
    proxy_pass http://linux_backend;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    proxy_read_timeout 300s;
    proxy_connect_timeout 75s;
}

# Socket.IO代理
location /socket.io/ {
    proxy_pass http://linux_backend;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 300s;
    proxy_connect_timeout 75s;
}

# WebSSH代理
location /webssh/ {
    proxy_pass http://linux_webssh/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 300s;
    proxy_connect_timeout 75s;
}
```

### Docker配置 (Dockerfile)
```dockerfile
# 设置环境变量
ENV NODE_ENV=production
ENV PORT=3001
ENV WEBSSH_PORT=3002
ENV FRONTEND_PORT=5173
ENV GRAFANA_PORT=8080

# 暴露端口
EXPOSE 3001 3002 5173 8080
```

### Docker编排 (docker-compose.yml)
```yaml
services:
  grafana-analytics:
    ports:
      - "3001:3001"  # 主应用端口（包含前端静态文件）
      - "3002:3002"  # WebSSH端口
      - "5173:5173"  # 前端开发服务器端口
      - "8080:8080"  # Grafana监控界面端口
```

### 启动脚本 (start-all.sh)
```bash
# 启动后端API服务器
print_message "启动后端API服务器 (端口 3001)..." $YELLOW
cd backend
nohup npm start > ../logs/backend.log 2>&1 &
BACKEND_PID=$!
cd ..

# 启动WebSSH服务器
print_message "启动WebSSH服务器 (端口 3002)..." $YELLOW
cd backend
nohup node webssh-server.js > ../logs/webssh.log 2>&1 &
WEBSSH_PID=$!
cd ..

# 启动前端开发服务器
print_message "启动前端开发服务器 (端口 5173)..." $YELLOW
cd frontend
nohup npm run dev > ../logs/frontend.log 2>&1 &
FRONTEND_PID=$!
cd ..

# 启动Grafana监控界面
print_message "启动Grafana监控界面 (端口 8080)..." $YELLOW
cd backend
nohup npm run start:grafana > ../logs/grafana.log 2>&1 &
GRAFANA_PID=$!
cd ..
```

## 📋 服务间依赖关系

### WebSSH服务器依赖
```javascript
// webssh-server.js连接到主API服务器
const mainServerSocket = ioClient('http://localhost:3001');

mainServerSocket.on('connect', () => {
  console.log('WebSSH服务器已连接到主API服务器');
});
```

### 前端服务依赖
- 前端(5173)通过Vite代理访问后端API(3001)
- 前端直接通过iframe访问WebSSH(3002)
- 前端代码中硬编码了端口号

## 🚨 当前问题

### 服务启动问题
- 端口3001(主API服务器)未运行，导致前端无法连接
- 端口5173(前端服务器)未运行，无法访问主界面
- WebSSH服务器无法连接到主API服务器(3001未运行)

### 端口分散问题
- 4个独立端口需要分别配置隧道转发
- 前端代码中硬编码了多个端口的URL构建逻辑
- Vite代理配置只覆盖了部分服务(缺少WebSSH和Grafana)

### 配置复杂性
- 多个CORS配置需要维护
- 前端URL构建逻辑复杂，需要检测环境
- Docker和启动脚本需要管理多个端口
