# 📋 求助文档 - 终端连接问题

## 🔍 当前状态
- **前端服务**: http://localhost:5176 (正常运行)
- **后端服务**: http://localhost:3001 (显示正常启动，但连接被拒绝)
- **WebSSH服务**: http://localhost:3002 (状态未知)

## ❌ 遇到的问题

### 主要问题：终端连接被拒绝
- **现象**: 用户可以正常登录聊天，图片功能正常，但终端显示"localhost 拒绝了我们的连接请求"
- **错误表现**: 终端iframe无法加载WebSSH服务
- **影响**: 用户无法使用Linux容器终端功能

## 🔧 已尝试的解决方案

### Socket.IO连接修复:
1. ✅ 修复了后端Socket.IO的CORS配置，添加5176端口支持
2. ✅ 修复了前端getBackendUrl函数，支持多端口检测
3. ✅ 添加了连接调试日志

### 图片功能修复:
1. ✅ 修复了图片URL生成逻辑，指向正确的后端服务器
2. ✅ 图片上传和显示功能完全正常

### 终端跨域问题修复:
1. ✅ 移除了所有直接访问iframe.contentWindow的代码
2. ✅ 改用postMessage进行iframe通信
3. ✅ 消除了跨域安全错误

### 数据库问题修复:
1. ✅ 添加了自动数据库迁移功能
2. ✅ 成功添加了message_type, image_url, mentions字段

## 📊 服务状态检查结果
```bash
# 端口监听状态
tcp6  0  0  :::3001  :::*  LISTEN  58281/node

# API健康检查
curl http://localhost:3001/api/health
{"status":"ok","timestamp":"2025-06-10T11:55:00.537Z"}
```

## 🔍 当前工作状态
- ✅ **聊天功能**: 完全正常，包括文本、图片、@用户
- ✅ **用户管理**: 登录、用户列表更新正常
- ✅ **图片上传**: 粘贴图片功能完全正常
- ❌ **终端功能**: WebSSH连接被拒绝

## 📁 相关代码文件
- `frontend/src/components/Terminal.jsx` - 终端组件，iframe加载WebSSH
- `backend/webssh-server.js` - WebSSH服务器
- `backend/server.js` - 主后端服务器，Socket.IO配置
- `frontend/src/App.jsx` - 前端主应用，Socket.IO连接逻辑

## 🔍 补充信息

### 控制台日志显示:
- Socket.IO连接成功
- 用户列表更新正常
- 图片加载成功: `http://localhost:3001/uploads/chat-image-1749556103066-435174415.png`
- 无跨域错误

### 终端URL构建逻辑:
```javascript
// 当前终端iframe src构建
const getWebSSHUrl = () => {
  if (window.location.hostname.includes('github.dev')) {
    let origin = window.location.origin;
    origin = origin.replace(/-517[3-9]/, '-3002');
    return origin;
  }
  return `${protocol}//${hostname}:3002`;
};
return `${getWebSSHUrl()}/ssh?username=${username}`;
```

### 可能的问题点:
1. **WebSSH服务器未启动**: 端口3002可能没有服务监听
2. **WebSSH服务器配置问题**: CORS或其他配置可能有问题
3. **容器连接问题**: WebSSH无法连接到Docker容器
4. **防火墙/网络问题**: 端口3002被阻止

## 🎯 需要解决的核心问题
WebSSH服务器(端口3002)连接被拒绝，导致终端功能无法使用。需要检查WebSSH服务器的启动状态和配置。

## 📝 测试步骤
1. 检查端口3002是否有服务监听: `netstat -tlnp | grep 3002`
2. 尝试直接访问WebSSH: `curl http://localhost:3002`
3. 检查WebSSH服务器日志
4. 验证Docker容器状态
5. 检查防火墙设置

## 🔧 建议的调试方向
1. 重启WebSSH服务器
2. 检查WebSSH服务器的启动脚本
3. 验证WebSSH与Docker的连接
4. 检查端口冲突问题
